name: C++ gRPC CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  VCPKG_ROOT: ${{ github.workspace }}/vcpkg
  BUILD_DIR: ${{ github.workspace }}/UserService/build

jobs:
  build_and_test:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      
      - name: 1.1 Free Disk Space
        run: |
          echo "Before cleaning:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "After cleaning:"
          df -h

      - name: 2. Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            ninja-build \
            zip \
            unzip \
            tar \
            libssl-dev \
            curl \
            gdb \
            bison \
            flex \
            autoconf \
            automake \
            libtool \
            git

      - name: 2.1 Clone vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git ${{ env.VCPKG_ROOT }}

      - name: 2.2 Bootstrap vcpkg
        run: ${{ env.VCPKG_ROOT }}/bootstrap-vcpkg.sh

      - name: 2.3 Setup vcpkg binary cache
        uses: actions/cache@v4
        with:
          # vcpkg 在 Linux runner 上的默认二进制缓存路径
          path: ~/.cache/vcpkg
          # 当 vcpkg.json 文件内容改变时，缓存的 key 改变
          key: vcpkg-binary-cache-${{ runner.os }}-${{ hashFiles('**/vcpkg.json') }}
          # Fallback key
          restore-keys: |
            vcpkg-binary-cache-${{ runner.os }}-

      - name: 3. Configure CMake
        run: |
          cmake -B $BUILD_DIR \
                -S $GITHUB_WORKSPACE/UserService \
                -G Ninja \
                -DCMAKE_BUILD_TYPE=Debug \
                -DCMAKE_MAKE_PROGRAM=/usr/bin/ninja \
                -DCMAKE_TOOLCHAIN_FILE=${{ env.VCPKG_ROOT }}/scripts/buildsystems/vcpkg.cmake

      - name: 4. Build project
        run: |
          cmake --build $BUILD_DIR --target UserServiceServer

      - name: 5. Run Program (冒烟测试)
        run: |
          echo "Attempting to start the server..."
          EXECUTABLE_PATH="$BUILD_DIR/UserServiceServer"
          
          cd "$BUILD_DIR"
          # 检查文件是否存在
          if [ ! -f "$EXECUTABLE_PATH" ]; then
            echo "Error: Executable not found at $EXECUTABLE_PATH"
            ls -R $BUILD_DIR
            exit 1
          fi

          # 1. 后台运行
          $EXECUTABLE_PATH &
          
          # 2. 拿到这个后台进程的 PID
          SERVER_PID=$!
          echo "Server started with PID ${SERVER_PID}"

          # 3. 等待 10 秒
          echo "Waiting 10 seconds for smoke test..."
          sleep 10

          # 4. 检查服务器进程是否还活着
          if kill -0 $SERVER_PID; then
            echo "SMOKE TEST SUCCESS: Server is still running after 10 seconds."
            # 5. 杀死服务，让 CI 步骤可以正常结束
            kill $SERVER_PID
          else
            echo "SMOKE TEST FAILED: Server crashed within 10 seconds!"
            exit 1 # 退出码非 0，标记 CI 失败
          fi
