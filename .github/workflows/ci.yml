name: C++ gRPC CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    container:
      image: seastarxy/grpc-dev:v2 # 你的公共镜像

    steps:
      - name: 1. Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: 2. Install Boost.Coroutine patch
        run: |
          apt-get update
          apt-get install -y libboost-coroutine-dev libssl-dev ninja-build
      
      - name: 3. Configure CMake (严格按照 CLion 命令)
        run: |
          # 定义构建目录，与你的 CLion 保持一致
          export BUILD_DIR=$GITHUB_WORKSPACE/UserService/build
          
          cmake -B $BUILD_DIR \
                -S $GITHUB_WORKSPACE/UserService \
                -G Ninja \
                -DCMAKE_BUILD_TYPE=Debug \
                -DCMAKE_MAKE_PROGRAM=/usr/bin/ninja \
                -DCMAKE_PREFIX_PATH=/usr/local/grpc_install
          
          # # 创建生成目录 (使用新的构建目录)
          # mkdir -p $BUILD_DIR/generated
                  
      - name: 4. Build project (严格按照 CLion 命令)
        run: |
          export BUILD_DIR=$GITHUB_WORKSPACE/UserService/build
          cmake --build $BUILD_DIR --target UserServiceServer

      - name: 5. Run Program (冒烟测试)
        run: |
          echo "Attempting to start the server..."
          EXECUTABLE_PATH="$GITHUB_WORKSPACE/UserService/build/UserService"

          # 检查文件是否存在
          if [ ! -f "$EXECUTABLE_PATH" ]; then
            echo "Error: Executable not found at $EXECUTABLE_PATH"
            # 列出 build 目录内容，方便你调试
            ls -R $GITHUB_WORKSPACE/UserService/build
            exit 1
          fi

          # 1. 把你的服务器程序放到后台运行
          $EXECUTABLE_PATH &
          
          # 2. 拿到这个后台进程的 PID
          SERVER_PID=$!
          echo "Server started with PID ${SERVER_PID}"

          # 3. 等待 5 秒钟
          sleep 5

          # 4. 检查服务器进程是否还活着
          # kill -0 $PID 不会真的杀死进程，只是检查进程是否存在
          if kill -0 $SERVER_PID; then
            echo "SMOKE TEST SUCCESS: Server is still running after 5 seconds."
            # 5. 杀死服务器，让 CI 步骤可以正常结束
            kill $SERVER_PID
          else
            echo "SMOKE TEST FAILED: Server crashed within 5 seconds!"
            exit 1 # 退出码非 0，标记 CI 失败
          fi
