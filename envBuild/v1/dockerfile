# =================================================================
#            修正版的最终 Dockerfile (Final Corrected Version)
# =================================================================

# 使用 Ubuntu 24.04 作为基础镜像
FROM ubuntu:24.04

# --- 1. 设置环境变量 ---
# 防止 apt-get 在安装时进行交互式提问
ENV DEBIAN_FRONTEND=noninteractive
# gRPC 和 Protobuf 版本 (确保它们相互兼容)
ARG GRPC_VERSION=v1.64.0
ARG PROTOBUF_VERSION=v27.1
# 自定义安装目录，方便管理
ENV MY_INSTALL_DIR=/usr/local/grpc_install
# 将可执行文件和库文件路径添加到系统环境中
ENV PATH="${MY_INSTALL_DIR}/bin:${PATH}"
ENV LD_LIBRARY_PATH="${MY_INSTALL_DIR}/lib:${MY_INSTALL_DIR}/lib64:${LD_LIBRARY_PATH:-}"

# --- 2. 安装所有开发和连接所需的工具 ---
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    autoconf \
    libtool \
    pkg-config \
    cmake \
    git \
    curl \
    wget \
    ca-certificates \
    gdb \
    openssh-server \
    libhiredis-dev \
    libpq-dev \
    zlib1g-dev \
    && rm -rf /var/lib/apt/lists/*

# --- 3. 【第1处关键改动】先独立编译并安装一个完整的 Protobuf ---
# 这一步确保 Protobuf 自身及其所有依赖 (如 utf8_range) 都被正确构建
RUN git clone --recurse-submodules --depth 1 --branch ${PROTOBUF_VERSION} https://github.com/protocolbuffers/protobuf.git /protobuf_source
WORKDIR /protobuf_source
RUN cmake -B build -Dprotobuf_BUILD_TESTS=OFF \
          -Dprotobuf_BUILD_SHARED_LIBS=OFF \
          -Dprotobuf_ENABLE_UTF8_VALIDATION=ON \
          -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
          -DCMAKE_INSTALL_PREFIX=${MY_INSTALL_DIR}
RUN cmake --build build -j$(nproc)
RUN cmake --install build
# 清理源码，减小镜像体积
RUN rm -rf /protobuf_source

# --- 4. 【第2处关键改动】基于已安装的 Protobuf 编译 gRPC ---
# 克隆指定版本的 gRPC 源码
RUN git clone --recurse-submodules -b ${GRPC_VERSION} --depth 1 --shallow-submodules https://github.com/grpc/grpc /grpc_source
WORKDIR /grpc_source
RUN mkdir -p cmake/build
WORKDIR /grpc_source/cmake/build
# 添加 -DgRPC_PROTOBUF_PROVIDER=package 和 -DCMAKE_PREFIX_PATH 告诉 gRPC 使用我们刚安装好的 Protobuf
RUN cmake -DgRPC_INSTALL=ON \
          -DgRPC_BUILD_TESTS=OFF \
          -DgRPC_PROTOBUF_PROVIDER=package \
          -DCMAKE_PREFIX_PATH=${MY_INSTALL_DIR} \
          -DCMAKE_CXX_STANDARD=17 \
          -DCMAKE_INSTALL_PREFIX=${MY_INSTALL_DIR} ../..
# 使用所有可用的 CPU核心进行编译
RUN make -j$(nproc)
# 安装到我们指定的环境变量目录 ${MY_INSTALL_DIR}
RUN make install
# 清理源码，减小镜像体积
RUN rm -rf /grpc_source

# --- 5. 配置 SSH 服务 ---
# 创建 sshd 运行目录
RUN mkdir /var/run/sshd
# 生成 SSH 主机密钥
RUN ssh-keygen -A
# 允许 root 用户通过密码登录 (仅限开发环境)
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
# 设置 root 用户的密码为 "1234"
RUN echo 'root:1234' | chpasswd

# --- 6. 暴露端口并设置启动命令 ---
# 暴露 SSH 服务的 22 端口
EXPOSE 22

# 设置容器的默认启动命令为启动 sshd 服务
# -D 选项让 sshd 在前台运行，这对于 Docker 是必需的
CMD ["/usr/sbin/sshd", "-D"]